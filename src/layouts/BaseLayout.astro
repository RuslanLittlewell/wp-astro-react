---
import globalStyles from "@styles/global.css?inline";
import { ClientRouter } from "astro:transitions";
import Header from "@/layouts/Header.astro";
import Footer from "./Footer.astro";
import Seo from "./Seo.astro";
import { wpFetch } from "@/lib/wp";
import { cn } from "@/lib/utils";
import GlobalSheet from "@/components/Shared/Modals/GlobalSheet";
import { CallbackModal } from "@/components/Shared/Modals/OrderCallModal";
import { FormResulatModal } from "@/components/Shared/Modals/FormResultModal";

const {
  title,
  description = "",
  keywords = "",
  canonical = "",
  image,
  jsonLd,
  className,
} = Astro.props;
const { acf } = await wpFetch("/acf/v3/options/options");
const userAgent = Astro.request?.headers.get("user-agent") ?? "";
const isBot =
  /bot|crawler|spider|crawling|lighthouse|gtmetrix|pagespeed/i.test(userAgent);

const links = [
  { name: "Главная", link: "/" },
  { name: "Автопарк", link: "/cars" },
  { name: "Условия", link: "/conditions" },
  {
    name: "Услуги",
    childs: [
      {
        name: "Прокат авто на сутки",
        link: "/arenda-avto-na-sutki",
      },
      {
        name: "Аренда авто на выходные",
        link: "/arenda-avto-na-vyhodnye",
      },
      {
        name: "Аренда авто на месяц",
        link: "/arenda-avto-na-mesyac",
      },
      {
        name: "Аренда авто без водителя",
        link: "/arenda-avto-bez-voditelya",
      },
      {
        name: "Аренда авто на свадьбу",
        link: "/arenda-avto-na-svadbu",
      },
      {
        name: "Аренда авто с водителем",
        link: "/arenda-avto-s-voditelem",
      },
      {
        name: "Каршеринг авто",
        link: "/karshering-avto",
      },
      {
        name: "Долгосрочная аренда автомобилей",
        link: "/dolgdolgosrochnaya-arenda-avtomobilej",
      },
    ],
  },
  { name: "Тарифы", link: "/tarifs" },
  { name: "Новости", link: "/blog" },
  { name: "Контакты", link: "#footer" },
];
---

<!doctype html>
<html lang="ru" class="h-full">
  <head>
    <Seo {title} {description} {keywords} {canonical} {image} />
    {
      jsonLd && (
        <script is:inline type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
      )
    }
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style is:global set:html={globalStyles}></style>
    <ClientRouter />
  </head>
  <body
    class={cn("min-h-screen bg-gray-50 text-gray-900 flex flex-col", className)}
  >
    <Header data={acf} {links} />
    <main class="flex-1">
      <slot />
    </main>
    <GlobalSheet client:load />
    <CallbackModal client:load />
    <FormResulatModal client:load />
    <Footer data={acf} {links} />

    {!isBot && (
      <>
        <script is:inline async type="text/javascript">
          (function () {
            if (typeof navigator === "undefined") {
              return;
            }
            (function (m, e, t, r, i, k, a) {
              m[i] =
                m[i] ||
                function () {
                  (m[i].a = m[i].a || []).push(arguments);
                };
              m[i].l = 1 * new Date();
              for (let j = 0; j < document.scripts.length; j++) {
                if (document.scripts[j].src === r) {
                  return;
                }
              }
              k = e.createElement(t);
              a = e.getElementsByTagName(t)[0];
              k.async = 1;
              k.src = r;
              a.parentNode.insertBefore(k, a);
            })(
              window,
              document,
              "script",
              "https://mc.yandex.ru/metrika/tag.js?id=105087199",
              "ym"
            );

            ym(105087199, "init", {
              ssr: true,
              webvisor: true,
              clickmap: true,
              ecommerce: "dataLayer",
              accurateTrackBounce: true,
              trackLinks: true,
            });
          })();
        </script>
        <noscript>
          <div>
            <img
              src="https://mc.yandex.ru/watch/105087199"
              style="position:absolute; left:-9999px;"
              alt=""
            />
          </div>
        </noscript>

        <script
          is:inline
          async
          src="https://www.googletagmanager.com/gtag/js?id=G-XLJDV4XM8V"
        ></script>
        <script is:inline async>
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            window.dataLayer.push(arguments);
          }
          gtag("js", new Date());
          gtag("config", "G-XLJDV4XM8V");
        </script>
      </>
    )}

    <meta name="yandex-verification" content="8209991da606eac9" />
  </body>
</html>
