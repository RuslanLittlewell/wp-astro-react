---
import { CarCard } from "@/components/Pages/Cars/CarCard";
import MainTitle from "@/components/Shared/MainTitle.astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import Container from "@/layouts/Container.astro";
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbPage,
  BreadcrumbSeparator,
} from "@/components/ui/breadcrumb";
import { wpFetch } from "@/lib/wp";
import FAQ from "@/components/Pages/Home/Sections/FAQ.astro";
import { getImage } from 'astro:assets';

interface Car {
  acf: any;
  title: {
    rendered: string;
  };
  slug: string;
}

const cars = await wpFetch('/wp/v2/cars?per_page=100');
const carsWithCovers = await Promise.all(
  cars.map(async (car: any) => {
    const [original] = car.acf?.car?.car_images ?? [];
    const cover = original
      ? await getImage({
          src: original,
          width: 640,
          format: 'webp',
          quality: 70,
        })
      : null;

    return { ...car, cover };
  }),
);
const page = await wpFetch('/wp/v2/pages/50');
const {acf: pageData} = page
const { seo } = pageData
const ymd = new Date().toISOString().split("T")[0];

const jsonLd = [
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    headline: seo.seo_title,
    datePublished: ymd,
    dateModified: ymd,
    inLanguage: "ru",
    description: seo.short_description,
    mainEntityOfPage: { "@type": "WebPage", "@id": "https://car1.by" },
    image: seo.image,
    email: "car1prokat@gmail.com",
    contactPoint: {
      "@type": "ContactPoint",
      telephone: "+375 25 780-88-08",
      contactType: "customer service",
      areaServed: "BY",
      availableLanguage: ["Russian", "English"],
    },
    address: {
      "@type": "PostalAddress",
      addressLocality: "Брест",
      addressCountry: "BY",
      streetAddress: "ул. Шоссейная, 16, офис 202",
    },
    sameAs: [
      "https://api.whatsapp.com/send/?phone=375257808808",
      "https://t.me/Car4_brest",
      "https://www.instagram.com/car4.by/",
    ],
  },
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    name: seo.seo_title,
    url: "https://car1.by/",
  },
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: [
      {
        "@type": "ListItem",
        position: 1,
        name: "Главная",
        item: "https://car1.by/",
      },
    ],
  },
];
---

<BaseLayout
  title={seo.seo_title}
  className="scrolled"
  image={seo.image}
  jsonLd={jsonLd}
  description={seo.short_description}
>
  <Container class="mt-24">
    <Breadcrumb>
      <BreadcrumbList>
        <BreadcrumbItem>
          <BreadcrumbLink href="/">Главная</BreadcrumbLink>
        </BreadcrumbItem>
        <BreadcrumbSeparator />
        <BreadcrumbItem>
          <BreadcrumbPage>{page.title.rendered}</BreadcrumbPage>
        </BreadcrumbItem>
      </BreadcrumbList>
    </Breadcrumb>
    <MainTitle title={page.title.rendered} />
  </Container>
  <Container big class="mb-24">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-[70px]">
      {carsWithCovers.map((car) => <CarCard car={car} cover={car.cover} client:load />)}
    </div>
      <FAQ fields={pageData.faq} />
  </Container>
</BaseLayout>
